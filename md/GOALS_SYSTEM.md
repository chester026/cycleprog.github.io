# Система целей (Goals System)

## Обзор

Система целей позволяет пользователям устанавливать и отслеживать прогресс в различных аспектах велоспортивной подготовки. Цели автоматически обновляются при появлении новых заездов в Strava.

## Архитектура

### Компоненты системы

1. **Frontend (React)**
   - `GoalsManager.jsx` - управление целями (создание, редактирование, удаление)
   - `PlanPage.jsx` - автоматическое обновление целей при изменении активностей
   - Кэширование активностей и целей

2. **Backend (Node.js/Express)**
   - API эндпоинты для CRUD операций с целями
   - Автоматическое обновление целей при добавлении поездок
   - Интеграция с Strava API

3. **Database (PostgreSQL)**
   - Таблица `goals` с полями для всех типов целей
   - Поддержка пользовательских настроек для FTP/VO2max целей

## Типы целей

### 1. Distance (Дистанция)
- **Описание**: Общая дистанция за период
- **Единица**: км
- **Расчет**: Сумма всех `distance` активностей за период
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 2. Time (Время)
- **Описание**: Общее время в движении
- **Единица**: часы
- **Расчет**: Сумма всех `moving_time` активностей за период / 3600
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 3. Elevation (Набор высоты)
- **Описание**: Общий набор высоты
- **Единица**: метры
- **Расчет**: Сумма всех `total_elevation_gain` активностей за период
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 4. Speed Flat (Скорость на равнине)
- **Описание**: Средняя скорость на равнинных участках
- **Единица**: км/ч
- **Расчет**: Средняя скорость активностей с `distance > 3000m` и `elevation < distance * 0.03`
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 5. Speed Hills (Скорость в горах)
- **Описание**: Средняя скорость на горных участках
- **Единица**: км/ч
- **Расчет**: Средняя скорость активностей с `distance > 3000m` и `elevation >= distance * 0.025`
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 6. Pulse (Средний пульс)
- **Описание**: Средний пульс за период
- **Единица**: bpm
- **Расчет**: Среднее значение `average_heartrate` всех активностей за период
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 7. Avg HR Flat (Средний пульс на равнине)
- **Описание**: Средний пульс на равнинных участках
- **Единица**: bpm
- **Расчет**: Среднее значение `average_heartrate` равнинных активностей
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 8. Avg HR Hills (Средний пульс в горах)
- **Описание**: Средний пульс на горных участках
- **Единица**: bpm
- **Расчет**: Среднее значение `average_heartrate` горных активностей
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 9. Avg Power (Средняя мощность)
- **Описание**: Средняя мощность за период
- **Единица**: W
- **Расчет**: Среднее значение `average_watts` всех активностей за период
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 10. Long Rides (Длинные заезды)
- **Описание**: Количество длинных заездов
- **Единица**: количество
- **Расчет**: Количество активностей с `distance >= 50000m`
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 11. Intervals (Интервальные тренировки)
- **Описание**: Количество интервальных тренировок
- **Единица**: количество
- **Расчет**: Активности с `type === 'Workout'` или `workout_type === 3`, или содержащие ключевые слова в названии
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 12. Recovery (Восстановительные заезды)
- **Описание**: Количество восстановительных заездов
- **Единица**: количество
- **Расчет**: Активности с низкой интенсивностью (Z2-Z3)
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 13. FTP/VO2max Workouts ⭐
- **Описание**: Время в высокоинтенсивных зонах
- **Единица**: минуты
- **Расчет**: Анализ времени в зонах выше порогового пульса
- **Обновление**: Только на фронтенде
- **Периоды**: 4w, 3m, year
- **Особенности**:
  - `hr_threshold`: Пороговый пульс (по умолчанию 160 BPM)
  - `duration_threshold`: Минимальная длительность сегмента (по умолчанию 120 секунд)
  - Пользователь может настраивать эти параметры
  - Значения сохраняются в базе данных

### 14. VO2max
- **Описание**: Максимальное потребление кислорода
- **Единица**: мл/кг/мин
- **Расчет**: Оценка на основе лучших показателей
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 15. FTP (Functional Threshold Power)
- **Описание**: Функциональная пороговая мощность
- **Единица**: W
- **Расчет**: Оценка на основе данных о мощности
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 16. Rides (Количество заездов)
- **Описание**: Общее количество заездов
- **Единица**: количество
- **Расчет**: Общее количество активностей типа 'Ride'
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

### 17. Avg Per Week (Среднее в неделю)
- **Описание**: Средние показатели в неделю
- **Единица**: зависит от типа
- **Расчет**: Среднее значение за неделю
- **Обновление**: Автоматическое на сервере
- **Периоды**: 4w, 3m, year

## Логика обновления целей

### Автоматическое обновление

1. **При загрузке активностей из Strava**:
   - Фронтенд получает новые активности
   - Сравнивает хеш активностей с предыдущим
   - При изменении вызывает `updateGoalsOnActivitiesChange`

2. **При добавлении ручных поездок**:
   - Сервер автоматически вызывает `updateUserGoals`
   - Обновляет `current_value` для соответствующих целей

3. **При импорте активностей**:
   - Сервер автоматически вызывает `updateUserGoals`
   - Обновляет `current_value` для соответствующих целей

### Специальная обработка FTP/VO2max целей

```javascript
// Цели ftp_vo2max пропускаются в updateUserGoals
case 'ftp_vo2max':
  // Для этих целей оставляем current_value как есть - они считаются на фронтенде
  continue; // Пропускаем обновление этих целей
```

### Сохранение пользовательских настроек

```javascript
// При обновлении целей передаются hr_threshold и duration_threshold
body: JSON.stringify({
  title: goal.title,
  description: goal.description,
  target_value: goal.target_value,
  current_value: currentValue,
  unit: goal.unit,
  goal_type: goal.goal_type,
  period: goal.period,
  hr_threshold: goal.hr_threshold,           // ✅ Сохраняется
  duration_threshold: goal.duration_threshold // ✅ Сохраняется
})
```

## Структура базы данных

### Таблица `goals`

```sql
CREATE TABLE goals (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  title VARCHAR(255),
  description TEXT,
  target_value DECIMAL(10,2),
  current_value DECIMAL(10,2),
  unit VARCHAR(50),
  goal_type VARCHAR(50),
  period VARCHAR(10),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  hr_threshold INTEGER DEFAULT 160,      -- Для ftp_vo2max целей
  duration_threshold INTEGER DEFAULT 120  -- Для ftp_vo2max целей
);
```

## API Эндпоинты

### GET /api/goals
- Получение всех целей пользователя
- Без автоматического обновления

### POST /api/goals
- Создание новой цели
- Поддержка всех полей включая `hr_threshold` и `duration_threshold`

### PUT /api/goals/:id
- Обновление цели
- Сохранение пользовательских настроек

### DELETE /api/goals/:id
- Удаление цели

### POST /api/goals/update-current
- Ручное обновление текущих значений целей

## Кэширование

### Frontend кэш
- Активности кэшируются на 30 минут
- Цели кэшируются в состоянии компонента
- Хеш активностей для предотвращения повторных обновлений

### Backend кэш
- Strava активности кэшируются на сервере
- TTL: 5 минут (ACTIVITIES_CACHE_TTL)

## Безопасность

- Все эндпоинты защищены `authMiddleware`
- Проверка `user_id` для всех операций
- Валидация входных данных

## Производительность

- Ленивая загрузка активностей
- Кэширование для уменьшения запросов к Strava API
- Хеширование для предотвращения лишних обновлений
- Пагинация при загрузке активностей из Strava (200 записей за раз)

## Мониторинг

- Логирование ошибок
- Отслеживание лимитов Strava API
- Мониторинг производительности запросов

## Будущие улучшения

1. **Уведомления**: Уведомления о достижении целей
2. **Графики прогресса**: Визуализация прогресса по времени
3. **Групповые цели**: Цели для команд
4. **Экспорт данных**: Экспорт прогресса в CSV/PDF
5. **Интеграции**: Интеграция с другими платформами 