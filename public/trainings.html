<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ Strava</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  
</head>
<body>
  <div class="header">
    <div class="nav">
      <a href="/"><span class="icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="trainings.html" class="active"><span class="icon">üö¥‚Äç‚ôÇÔ∏è</span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
      <a href="plan.html"><span class="icon">üìà</span>–ê–Ω–∞–ª–∏–∑ –∏ –ø–ª–∞–Ω</a>
      <a href="checklist.html"><span class="icon">üìã</span>–ß–µ–∫-–ª–∏—Å—Ç</a>
    </div>
    <div class="header-actions" style="display:none; gap:0.7em;">
      <button id="strava-login-header" class="header-btn" style="background:#ff6600; color:#fff; border:none; border-radius:6px; padding:0.5em 1.1em; font-size:1em; font-weight:600; cursor:pointer;">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <button id="download-json-header" class="header-btn" style="background:#ededed; color:#333; border:none; border-radius:6px; padding:0.5em 1.1em; font-size:1em; font-weight:600; cursor:pointer; display:none;">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
    </div>
  </div>
  <div class="container">
    <nav class="sidebar">
      <a href="/"><span class="icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="trainings.html" class="active"><span class="icon">üö¥‚Äç‚ôÇÔ∏è</span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
      <a href="plan.html"><span class="icon">üìà</span>–ê–Ω–∞–ª–∏–∑ –∏ –ø–ª–∞–Ω</a>
      <a href="checklist.html"><span class="icon">üìã</span>–ß–µ–∫-–ª–∏—Å—Ç</a>
      <br>
      <button id="strava-login">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <button id="download-json" style="display:none;">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
      
    </nav>
    <div class="main main-relative">
      <h1>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ Strava</h1>
      <div id="main-loader" class="main-loader"><div></div></div>
      <div id="totals">
        <div class="total-card">
          <div class="total-label">–í—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ</div>
          <span class="metric-value"><span class="big-number" id="total-distance">‚Äî</span><span class="unit">–∫–º</span></span>
        </div>
        <div class="total-card">
          <div class="total-label">–ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã</div>
          <span class="metric-value"><span class="big-number" id="total-elevation">‚Äî</span><span class="unit">–º</span></span>
        </div>
        <div class="total-card">
          <div class="total-label">–í—Ä–µ–º—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏</div>
          <span class="metric-value"><span class="big-number" id="total-moving-time">‚Äî</span><span class="unit">—á</span></span>
        </div>
        <div class="total-card">
          <div class="total-label">–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å</div>
          <span class="metric-value"><span class="big-number" id="total-avg-speed">‚Äî</span><span class="unit">–∫–º/—á</span></span>
        </div>
      </div>
      <div id="filters">
        <span style="font-weight:600; font-size:0.9em; color:#222; margin-right:1.5em; align-self:baseline;">–§–∏–ª—å—Ç—Ä—ã</span>
        <button id="toggle-filters" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" style="position:absolute; right:1em; left:auto; top:15px; background:none; border:none; font-size:1em; cursor:pointer; color:#ff6600;">‚ñ≤</button>
        <div id="filters-fields" style="display:none; flex-wrap:wrap; gap:1.2em; align-items:flex-end; width:100%;">
          <div>
            <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é<br><input type="text" id="filter-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." style="width: 160px;"></label>
          </div>
          <div>
            <label>–î–∞—Ç–∞ –æ—Ç<br><input type="date" id="filter-date-from"></label>
          </div>
          <div>
            <label>–î–∞—Ç–∞ –¥–æ<br><input type="date" id="filter-date-to"></label>
          </div>
          <div>
            <label>–¢–∏–ø<br><select id="filter-type" style="width: 120px;"><option value="">–í—Å–µ</option></select></label>
          </div>
          <div>
            <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)<br><input type="number" id="filter-dist-min" placeholder="–æ—Ç" style="width:60px;"> ‚Äì <input type="number" id="filter-dist-max" placeholder="–¥–æ" style="width:60px;"></label>
          </div>
          <div>
            <label>–°—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)<br><input type="number" id="filter-speed-min" placeholder="–æ—Ç" style="width:60px;"> ‚Äì <input type="number" id="filter-speed-max" placeholder="–¥–æ" style="width:60px;"></label>
          </div>
          <div>
            <label>–°—Ä. –ø—É–ª—å—Å<br><input type="number" id="filter-hr-min" placeholder="–æ—Ç" style="width:60px;"> ‚Äì <input type="number" id="filter-hr-max" placeholder="–¥–æ" style="width:60px;"></label>
          </div>
          <div>
            <label>–ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã (–º)<br><input type="number" id="filter-elev-min" placeholder="–æ—Ç" style="width:60px;"> ‚Äì <input type="number" id="filter-elev-max" placeholder="–¥–æ" style="width:60px;"></label>
          </div>
          <div style="flex:1 1 100%; text-align:right;">
            <button id="reset-filters" style="background:#ededed; color:#333; border:none; border-radius:6px; padding:0.5em 1.2em; font-size:1em; cursor:pointer; margin-top:0.5em;">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
          </div>
        </div>
      </div>
      <div id="activities"></div>
    </div>
  </div>
  <script>
    const clientId = '165560';
    const redirectUri = window.location.origin + '/exchange_token';
    const scope = 'activity:read_all';

    let lastActivities = [];
    let allActivities = [];

    document.getElementById('strava-login').onclick = function() {
      const url = `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&approval_prompt=auto&scope=${scope}`;
      window.location.href = url;
    };

    document.getElementById('download-json').onclick = function() {
      if (!lastActivities.length) return;
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(lastActivities, null, 2));
      const dl = document.createElement('a');
      dl.setAttribute('href', dataStr);
      dl.setAttribute('download', 'strava_activities.json');
      document.body.appendChild(dl);
      dl.click();
      document.body.removeChild(dl);
    };

    async function fetchActivities() {
      try {
        const res = await fetch('/activities');
        if (!res.ok) return;
        const activities = await res.json();
        allActivities = activities;
        updateTypeFilterOptions(activities);
        applyFiltersAndRender();
        fetch('/activities')
          .then(res => res.json())
          .then(activities => {
            const totalMeters = activities.reduce((sum, act) => sum + (act.distance || 0), 0);
            const totalKm = (totalMeters / 1000).toFixed(1);
            const totalElev = activities.reduce((sum, act) => sum + (act.total_elevation_gain || 0), 0);
            const totalMovingSec = activities.reduce((sum, act) => sum + (act.moving_time || 0), 0);
            const totalMovingHours = (totalMovingSec / 3600).toFixed(1);
            // –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –≤—Å–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º (–æ–±—â–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è / –æ–±—â–µ–µ –≤—Ä–µ–º—è)
            let avgSpeed = '‚Äî';
            if (totalMovingSec > 0) {
              avgSpeed = ((totalMeters / 1000) / (totalMovingSec / 3600)).toFixed(1);
            }
            document.getElementById('total-distance').textContent = totalKm;
            document.getElementById('total-elevation').textContent = Math.round(totalElev);
            document.getElementById('total-moving-time').textContent = totalMovingHours;
            document.getElementById('total-avg-speed').textContent = avgSpeed;
            document.getElementById('main-loader').style.display = 'none';
          })
          .catch(() => {
            document.getElementById('total-distance').textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            document.getElementById('total-elevation').textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            document.getElementById('total-moving-time').textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            document.getElementById('total-avg-speed').textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            document.getElementById('main-loader').style.display = 'none';
          });
      } catch (e) {
        // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞
      }
    }

    function updateTypeFilterOptions(activities) {
      const select = document.getElementById('filter-type');
      const types = Array.from(new Set(activities.map(a => a.type).filter(Boolean)));
      select.innerHTML = '<option value="">–í—Å–µ</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function applyFiltersAndRender() {
      let filtered = allActivities.slice();
      const name = document.getElementById('filter-name').value.trim().toLowerCase();
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;
      const type = document.getElementById('filter-type').value;
      const distMin = parseFloat(document.getElementById('filter-dist-min').value);
      const distMax = parseFloat(document.getElementById('filter-dist-max').value);
      const speedMin = parseFloat(document.getElementById('filter-speed-min').value);
      const speedMax = parseFloat(document.getElementById('filter-speed-max').value);
      const hrMin = parseFloat(document.getElementById('filter-hr-min').value);
      const hrMax = parseFloat(document.getElementById('filter-hr-max').value);
      const elevMin = parseFloat(document.getElementById('filter-elev-min').value);
      const elevMax = parseFloat(document.getElementById('filter-elev-max').value);

      filtered = filtered.filter(a => {
        if (name && !(a.name || '').toLowerCase().includes(name)) return false;
        if (dateFrom && (!a.start_date || new Date(a.start_date) < new Date(dateFrom))) return false;
        if (dateTo && (!a.start_date || new Date(a.start_date) > new Date(dateTo + 'T23:59:59'))) return false;
        if (type && a.type !== type) return false;
        if (!isNaN(distMin) && (!a.distance || a.distance/1000 < distMin)) return false;
        if (!isNaN(distMax) && (!a.distance || a.distance/1000 > distMax)) return false;
        if (!isNaN(speedMin) && (!a.average_speed || a.average_speed*3.6 < speedMin)) return false;
        if (!isNaN(speedMax) && (!a.average_speed || a.average_speed*3.6 > speedMax)) return false;
        if (!isNaN(hrMin) && (!a.average_heartrate || a.average_heartrate < hrMin)) return false;
        if (!isNaN(hrMax) && (!a.average_heartrate || a.average_heartrate > hrMax)) return false;
        if (!isNaN(elevMin) && (!a.total_elevation_gain || a.total_elevation_gain < elevMin)) return false;
        if (!isNaN(elevMax) && (!a.total_elevation_gain || a.total_elevation_gain > elevMax)) return false;
        return true;
      });
      renderActivities(filtered);
    }

    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä—ã
    window.addEventListener('DOMContentLoaded', () => {
      [
        'filter-name','filter-date-from','filter-date-to','filter-type',
        'filter-dist-min','filter-dist-max',
        'filter-speed-min','filter-speed-max',
        'filter-hr-min','filter-hr-max',
        'filter-elev-min','filter-elev-max'
      ].forEach(id => {
        document.getElementById(id).addEventListener('input', applyFiltersAndRender);
      });
      document.getElementById('reset-filters').onclick = function() {
        document.getElementById('filter-name').value = '';
        document.getElementById('filter-date-from').value = '';
        document.getElementById('filter-date-to').value = '';
        document.getElementById('filter-type').value = '';
        document.getElementById('filter-dist-min').value = '';
        document.getElementById('filter-dist-max').value = '';
        document.getElementById('filter-speed-min').value = '';
        document.getElementById('filter-speed-max').value = '';
        document.getElementById('filter-hr-min').value = '';
        document.getElementById('filter-hr-max').value = '';
        document.getElementById('filter-elev-min').value = '';
        document.getElementById('filter-elev-max').value = '';
        applyFiltersAndRender();
      };
      document.getElementById('toggle-filters').onclick = function() {
        const fields = document.getElementById('filters-fields');
        const btn = document.getElementById('toggle-filters');
        if (fields.style.display === 'none') {
          fields.style.display = 'flex';
          btn.textContent = '‚ñº';
        } else {
          fields.style.display = 'none';
          btn.textContent = '‚ñ≤';
        }
      };
    });

    function renderActivities(activities) {
      lastActivities = activities;
      document.getElementById('download-json').style.display = activities.length ? '' : 'none';
      document.getElementById('download-json-header').style.display = activities.length && window.innerWidth <= 1180 ? '' : 'none';
      const div = document.getElementById('activities');
      if (!activities.length) {
        div.innerHTML = '<p>–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>';
        return;
      }
      const fieldMap = {
        distance: { label: '–î–∏—Å—Ç–∞–Ω—Ü–∏—è', unit: '–∫–º' },
        moving_time: { label: '–í—Ä–µ–º—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏', unit: '–º–∏–Ω' },
        elapsed_time: { label: '–û–±—â–µ–µ –≤—Ä–µ–º—è', unit: '–º–∏–Ω' },
        total_elevation_gain: { label: '–ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã', unit: '–º' },
        average_speed: { label: '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å', unit: '–∫–º/—á' },
        max_speed: { label: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å', unit: '–∫–º/—á' },
        average_cadence: { label: '–°—Ä–µ–¥–Ω–∏–π –∫–∞–¥–µ–Ω—Å', unit: '–æ–±/–º–∏–Ω' },
        average_temp: { label: '–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', unit: '¬∞C' },
        average_heartrate: { label: '–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å', unit: '—É–¥/–º–∏–Ω' },
        max_heartrate: { label: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å', unit: '—É–¥/–º–∏–Ω' },
        elev_high: { label: '–ú–∞–∫—Å. –≤—ã—Å–æ—Ç–∞', unit: '–º' }
      };
      div.innerHTML = activities.map((a, idx) => {
        const title = a.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const startDate = a.start_date ? new Date(a.start_date).toLocaleString() : '';
        const activityData = {};
        Object.keys(fieldMap).forEach(key => {
          let value = a[key];
          if (value == null) value = '-';
          if (key === 'distance' && value !== '-') value = (value / 1000).toFixed(2);
          if ((key === 'moving_time' || key === 'elapsed_time') && value !== '-') value = (value / 60).toFixed(1);
          if ((key === 'average_speed' || key === 'max_speed') && value !== '-') value = (value * 3.6).toFixed(2);
          activityData[key] = value;
        });
        activityData.name = a.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        return `<div class="activity" style="position:relative;">
          <button id="copybtn" class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON" data-idx="${idx}" style="position:absolute; top:1.2em; right:1.2em; background:#ededed; color:#000; border:none; border-radius:2px; padding:0.3em 0.8em; font-size:0.98em; cursor:pointer; transition:background 0.18s;">‚ßâ</button>
          <div class="activity-title">${title}</div>
          <div class="activity-date" style="color:#888; font-size:0.9em; margin-bottom:0.7em;">${startDate}</div>
          <table class="activity-table">
            <tbody>
              ${Object.entries(fieldMap).map(([key, {label, unit}]) => {
                let value = a[key];
                if (value == null) value = '-';
                if (key === 'distance' && value !== '-') value = (value / 1000).toFixed(2);
                if ((key === 'moving_time' || key === 'elapsed_time') && value !== '-') value = (value / 60).toFixed(1);
                if ((key === 'average_speed' || key === 'max_speed') && value !== '-') value = (value * 3.6).toFixed(2);
                return `<tr><td>${label}</td><td>${value}</td><td>${unit}</td></tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
      }).join('');

      // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.onclick = function(e) {
          const idx = +btn.getAttribute('data-idx');
          // –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
          const a = activities[idx];
          const activityData = {};
          Object.keys(fieldMap).forEach(key => {
            let value = a[key];
            if (value == null) value = '-';
            if (key === 'distance' && value !== '-') value = (value / 1000).toFixed(2);
            if ((key === 'moving_time' || key === 'elapsed_time') && value !== '-') value = (value / 60).toFixed(1);
            if ((key === 'average_speed' || key === 'max_speed') && value !== '-') value = (value * 3.6).toFixed(2);
            activityData[key] = value;
          });
          activityData.name = a.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
          navigator.clipboard.writeText(JSON.stringify(activityData, null, 2));
          btn.textContent = '‚úî';
          setTimeout(() => { btn.textContent = '‚ßâ'; }, 1200);
        };
      });
    }

    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å—Ä–∞–∑—É (–µ—Å–ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã)
    fetchActivities();

    // –î—É–±–ª–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ö–µ–¥–µ—Ä–µ (–º–æ–±. –≤–µ—Ä—Å–∏—è)
    function updateHeaderActionsVisibility() {
      const actions = document.querySelector('.header-actions');
      if (window.innerWidth <= 1180) {
        actions.style.display = 'flex';
      } else {
        actions.style.display = 'none';
      }
    }
    window.addEventListener('resize', updateHeaderActionsVisibility);
    window.addEventListener('DOMContentLoaded', updateHeaderActionsVisibility);
    document.getElementById('strava-login-header').onclick = document.getElementById('strava-login').onclick;
    document.getElementById('download-json-header').onclick = document.getElementById('download-json').onclick;
  </script>
</body>
</html>
